import tkinter as tk
from tkinter import filedialog, messagebox
from PIL import Image, ImageTk

import torch
from PIL import Image
from transformers import (
    VisionEncoderDecoderModel,
    ViTImageProcessor,
    GPT2TokenizerFast
)

MODEL_DIR = "tsr_vit_tablebank_v1" 
MAX_LENGTH = 128
NUM_BEAMS = 4

print("Loading model...")
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")

model = VisionEncoderDecoderModel.from_pretrained(MODEL_DIR).to(device)
tokenizer = GPT2TokenizerFast.from_pretrained(MODEL_DIR)
image_processor = ViTImageProcessor.from_pretrained(MODEL_DIR)

model.eval()
print("Model loaded.")

def run_inference(image_path):
    image = Image.open(image_path).convert("RGB")
    
    pixel_values = image_processor(images=image, return_tensors="pt").pixel_values.to(device)

    output_ids = model.generate(
        pixel_values,
        max_length=MAX_LENGTH,
        num_beams=NUM_BEAMS,
        early_stopping=True
    )

    prediction = tokenizer.decode(output_ids[0], skip_special_tokens=True)
    return prediction


def choose_image():
    filepath = filedialog.askopenfilename(
        title="Select Table Image",
        filetypes=[("Image Files", "*.png *.jpg *.jpeg *.bmp *.tiff")]
    )

    if not filepath:
        return
    
    try:
        result = run_inference(filepath)

        result_window = tk.Toplevel(root)
        result_window.title("Extracted Table Structure")

        print(f"\n=== Selected Image ===\n{filepath}")

        file_label = tk.Label(result_window, text=f"Selected Image:\n{filepath}")
        file_label.pack(pady=5)

        img = Image.open(filepath)
        img.thumbnail((300, 300))  
        img_tk = ImageTk.PhotoImage(img)

        img_label = tk.Label(result_window, image=img_tk)
        img_label.image = img_tk  
        img_label.pack(pady=10)

        text_widget = tk.Text(result_window, wrap="word", height=20, width=80)
        text_widget.pack(padx=10, pady=10)
        text_widget.insert(tk.END, result)

        print("\nExtracted HTML Tokens\n")
        print(result)

    except Exception as e:
        messagebox.showerror("Error", str(e))


root = tk.Tk()
root.title("Table Structure Recognition - TSR Inference")

select_btn = tk.Button(root, text="Select Table Image", command=choose_image, width=30)
select_btn.pack(pady=20)

info_label = tk.Label(root, text="Choose an image to extract its table HTML structure.")
info_label.pack()

root.mainloop()
